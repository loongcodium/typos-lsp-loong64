name: Check, build, release!

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to build/release (e.g., v0.1.14). If empty, the latest upstream version will be used after checking for updates.'
        required: false
        default: ''
      release_version:
        description: 'The version to use in release (e.g., v0.1.14-1). If empty, the release workflow will not be triggered.'
        required: false
        default: ''

jobs:
  determine_version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_logic.outputs.version }}
      release_version: ${{ steps.version_logic.outputs.release_version }}
      should_build: ${{ steps.version_logic.outputs.should_build }}
    steps:
      - name: Determine version and whether to build
        id: version_logic
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Building specified version: ${{ github.event.inputs.version }}"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "release_version=${{ github.event.inputs.release_version }}" >> $GITHUB_OUTPUT
          else
            echo "Checking for newer upstream version..."
            sudo apt-get update && sudo apt-get install -y jq
            UPSTREAM_VERSION=$(curl -s https://api.github.com/repos/tekumara/typos-lsp/releases/latest | jq -r .tag_name)
            OWN_VERSION=$(curl -sL https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "v0.0.0")
            echo "Upstream version: $UPSTREAM_VERSION"
            echo "Own version: $OWN_VERSION"
            UPSTREAM_VERSION_NUM=${UPSTREAM_VERSION#v}
            OWN_VERSION_NUM=${OWN_VERSION#v}
            if dpkg --compare-versions "$UPSTREAM_VERSION_NUM" "gt" "$OWN_VERSION_NUM"; then
              echo "Newer upstream version found: $UPSTREAM_VERSION"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
              echo "release_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
            else
              echo "No newer upstream version found."
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "version=" >> $GITHUB_OUTPUT
              echo "release_version=" >> $GITHUB_OUTPUT
            fi
          fi

  build:
    needs: determine_version
    if: needs.determine_version.outputs.should_build == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            target: loongarch64-unknown-linux-gnu
            code-target: linux-loong64
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: tekumara/typos-lsp
          ref: ${{ needs.determine_version.outputs.version }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - name: Install GCC loongarch64 (linux)
        # TODO: switch to gcc-loongarch64-linux-gnu when available
        run: sudo apt-get update && sudo apt-get install gcc-14-loongarch64-linux-gnu
      - name: Patch metadata
        run: |
          cat package.json | \
          jq '.displayName="Typos spell checker (loong64)"' | \
          jq '.description=(.description) + " (This version is for LoongArch64 only)"' | \
          jq '.version="${{ needs.determine_version.outputs.release_version }}"|ltrimstr("v")' | \
          jq '.publisher="loong-vsx"' | \
          jq '.homepage="https://github.com/loongcodium/typos-lsp-loong64"' | \
          jq '.repository.url="https://github.com/loongcodium/typos-lsp-loong64.git"' | \
          jq '.bugs.url="https://github.com/loongcodium/typos-lsp-loong64/issues"' \
          > tmp.json && mv -v tmp.json package.json
      - name: Build ${{ matrix.target }}
        run: |
          export CARGO_TARGET_LOONGARCH64_UNKNOWN_LINUX_GNU_LINKER=loongarch64-linux-gnu-gcc-14
          cargo build --target ${{ matrix.target }} --release
      - run: npm ci
      - name: vsce package
        shell: bash
        run: |
          mkdir -p bundled dist
          cp target/${{ matrix.target }}/release/typos-lsp* bundled/
          npx vsce package -o dist/
      - name: Archive
        shell: bash
        run: |
          ver=${{ needs.determine_version.outputs.version }}
          archive="dist/typos-lsp-$ver-${{ matrix.target }}"
          mkdir -p dist
          tar czf "${archive}.tar.gz" -C target/${{ matrix.target }}/release typos-lsp
          ls -al dist/*
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist

  release:
    name: release
    runs-on: ubuntu-latest
    needs: [determine_version, build]
    if: needs.determine_version.outputs.should_build == 'true' && needs.determine_version.outputs.release_version
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Tag version
        run: |
          git tag ${{ needs.determine_version.outputs.release_version }}
          git push origin ${{ needs.determine_version.outputs.release_version }}
      - uses: actions/download-artifact@v5
      - run: ls -al
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine_version.outputs.release_version }}
          files: |
            ./**/*.vsix
            ./**/*.tar.gz

      - name: Install ovsx
        run: npm install --global ovsx
      - name: Publish extension
        run: ovsx publish ./*.vsix
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
